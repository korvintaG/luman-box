## Описание

Разработанный Telegram-бот обеспечивает эффект "одного сообщения" от бота, а также автоматически удаляет ненужные сообщения пользователя, чтобы минимизировать загромождение чата.

Для создания бота использовалась библиотека Telegraf, а также изолированные сцены и кастомный стейт контекста, позволяющий хранить промежуточные данные в памяти сессии, что упрощает управление состоянием пользователя без лишних обращений к базе данных Postgres.

## Telegraf
Самая популярная библиотека для создания Telegram-ботов на NestJS — это nestjs-telegraf. Она объединяет мощь фреймворка NestJS и библиотеки Telegraf, предоставляя удобный и гибкий способ разработки ботов с поддержкой всех возможностей NestJS, таких как guards, interceptors, filters и pipes. Она предоставляет простой и удобный API для взаимодействия с Telegram Bot API. 

### Основные особенности

- Поддержка middleware для обработки сообщений.

- Удобная работа с командами, текстом, кнопками и другими типами сообщений.

- Поддержка сцен (Scenes) для создания многошаговых диалогов.

- Легкая интеграция с другими библиотеками и сервисами.

## Сцены 
Cцены (или "Scenes") — это функция библиотеки Telegraf, которая позволяет пользователям создавать интерактивные и динамические интерфейсы в ботах или мини-приложениях. Сцены используются для организации взаимодействия с пользователем, например, для пошагового ввода данных, настройки параметров или выполнения сложных действий.

### Основные особенности сцен:
- Интерактивность: Сцены позволяют создавать диалоги с пользователем, где каждый шаг зависит от предыдущего.
- Гибкость: Можно создавать сложные сценарии, например, формы для заполнения, опросы, выбор параметров и т.д.
- Удобство: Пользователь видит только ту информацию, которая нужна на текущем этапе, что упрощает взаимодействие.

### Как это работает:
- Пользователь запускает бота или мини-приложение.
- Бот переключает пользователя между сценами, запрашивая данные или предлагая выбор.
- Каждая сцена может содержать текст, кнопки, медиафайлы или другие элементы интерфейса.
- После завершения сцены бот может обработать данные и перейти к следующему шагу.

Сцены делают взаимодействие с ботом более удобным и интуитивно понятным, а код в формате сцен читать удобнее.


## Контекст (ctx)
В библиотеке nestjs-telegraf объект ctx (сокращение от context) — это контекст выполнения, который содержит всю информацию о текущем сообщении, пользователе, чате и других данных, связанных с запросом. Это основной объект, с которым сервис работает при обработке сообщений или событий в Telegram-боте.

### ctx используется: 
- При обработке команд (/start, /menu и т.д.).
- При обработке текстовых сообщений, фото, аудио и других типов контента.
- При работе с inline-клавиатурами и callback-запросами.
- При использовании сцен (Scenes) для многошаговых диалогов.

### Объект ctx включает в себя:

#### Информацию о сообщении:

- ctx.message — текстовое сообщение или медиафайл, отправленный пользователем.
- ctx.callbackQuery — данные о callback-запросе (например, нажатие на кнопку в inline-клавиатуре).
- ctx.update — полное обновление (update) от Telegram API, которое содержит все данные о событии.

#### Информацию о пользователе и чате:
- ctx.from — данные о пользователе, отправившем сообщение (например, id, username, first_name).
- ctx.chat — данные о чате, в котором было отправлено сообщение (например, id, type).

#### Методы для взаимодействия:
- ctx.reply(text) — отправить ответное сообщение в чат.
- ctx.telegram.sendMessage(chatId, text) — отправить сообщение в указанный чат.
- ctx.editMessageText(text) — изменить текст сообщения (например, после нажатия на inline-кнопку).
- ctx.scene.enter(sceneName) — перейти к другой сцене (если используются сцены).

#### Дополнительные данные:
- ctx.session — данные сессии, которые сохраняются между запросами (например, состояние пользователя).

## Сессия (ctx.session)
ctx.session — это механизм для хранения данных, связанных с конкретным пользователем или чатом, в течение сессии. Это полезно для сохранения состояния пользователя, данных, введенных пользователем, настроек или промежуточных результатов взаимодействия с ботом. По умолчанию данные сессии хранятся в оперативной памяти (RAM), соответственно, данные хранятся только пока бот/сервер не будет перезапущен.

В данном проекте хранение данных для промежуточной логики (стейт) осуществляется в сессии, интерфейс, описывающй структуру данных: ITelegramUserState, класс, создающий стейт - UserState и его метод create.

Доступ к стейту осущесвляется из конткеста ctx.session\[chatId\], где по ключу chatId пользователя записываются все необходимые данные. 


## Процесс регистрации пользователя

- На каждом шаге регистрации данные пользователя проверяются на уникальность (имя пользователя) и валидность (имя пользователя и пароль).

- Промежуточные данные сохраняются в стейте сессии cts.session\[chatId\], таблице telegram-session базы данных Postgres. Это обеспечивает сохранность данных в случае отключения сервера во время сессии.

- После завершения регистрации финальные данные пользователя передаются через метод AuthService create и записываются в таблицу users базы данных Postgres. Пароль пользователя хранится в защищенном виде.

## Дополнительные функции

- Зарегистрированный пользователь может изменить пароль с помощщью бота (с применением метода AuthService update).

- Идентификация пользователя в боте происходит исключительно по chat_id, что обеспечивает безопасность и удобство.

Таким образом, бот обеспечивает удобный и безопасный процесс регистрации, а также минимизирует визуальный шум в чате за счет удаления ненужных сообщений.

## Струкура модуля

```text
telegram/
├── dto/
│ ├── create-telegram-sessions.entity.ts
│ ├── update-telegram-sessions.entity.ts
├── entities/
│ ├── telegram-sessions.entity.ts
├── scenes/
│ ├── main.scene.ts  **основная сцена, имитирующая "главную страницу"
│ ├── messages.ts  **шаблоны всех ответных сообщений и инлайновых клавиатур с логикой, построенной в зависимости от стейта
│ ├── registration.scene.ts **сцена Регистрация 
│ ├── submitPassword.scene.ts **сцена создания и обновления пароля
│ ├── submitUsername.scene.ts **сцена создания и обновления логина
├── telgram-sessions.service.ts **Файл сервиса для взаимодействия с таблицей telegram-sessions БД Postgres
├── telegram.bot.ts **Файл запуска бота, обрабатывающий команду /start и задающий стартовый стейт сессии
├── telegram.module.ts **Основная настройка бота и подключение middleware и сцен
├── telegram.patterns.ts **Содержит текстовые шаблоны ответов и надписей кнопок, а также названия сцен и коллбэков
├── telegram.types.ts **Описывает интерфейсы пользователя бота и стейта сессии
└── utils.ts **Содержит вспомогательные функции санитизации логина, пароля, удаления сообщений и создания декоратора chatId
```

## Функционал
Пояснения по логике работе классов и функций расположены непосредственно в коде в виде комментариев. 

## Источники
- Документация NestJS Telegraf  https://www.npmjs.com/package/nestjs-telegraf 
- Документация по сценаам Telegraf https://telegraf.js.org/modules/scenes.html 
- Пример бота на NestJS Telegraf https://habr.com/ru/companies/tbank/articles/596287/ 

